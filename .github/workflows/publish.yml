name: Publish to npm & MCP Registry

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build
        run: npm run build

      - name: Run tests
        run: npm test

  publish:
    needs: test
    runs-on: ubuntu-latest

    permissions:
      contents: write
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Get version from tag
        id: version
        env:
          GIT_REF: ${{ github.ref }}
        run: |
          VERSION=${GIT_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Update server.json version
        env:
          PKG_VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$PKG_VERSION\"/g" server.json

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build
        run: npm run build

      - name: Generate SBOM
        uses: anchore/sbom-action@v0
        with:
          format: cyclonedx-json
          output-file: sbom.cdx.json

      - name: Publish to npm
        id: npm-publish
        run: npm publish --access public --provenance 2>&1 || echo "NPM_PUBLISH_FAILED=true" >> $GITHUB_OUTPUT
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Check npm publish result
        env:
          NPM_FAILED: ${{ steps.npm-publish.outputs.NPM_PUBLISH_FAILED }}
        run: |
          if [ "$NPM_FAILED" = "true" ]; then
            echo "::warning::npm publish failed (version may already exist). Continuing..."
          fi

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get MCP Publisher Private Key
        id: mcp-key
        run: |
          PRIVATE_KEY=$(az keyvault secret show \
            --vault-name kv-ansvar-dev \
            --name mcp-publisher-private-key \
            --query value -o tsv)
          echo "::add-mask::$PRIVATE_KEY"
          echo "PRIVATE_KEY=$PRIVATE_KEY" >> $GITHUB_OUTPUT

      - name: Install MCP Publisher
        run: |
          curl -L -o mcp-publisher.tar.gz \
            https://github.com/modelcontextprotocol/registry/releases/download/v1.4.0/mcp-publisher_linux_amd64.tar.gz
          tar -xzf mcp-publisher.tar.gz
          chmod +x mcp-publisher
          sudo mv mcp-publisher /usr/local/bin/
          mcp-publisher --version

      - name: Authenticate with MCP Registry
        env:
          PRIVATE_KEY: ${{ steps.mcp-key.outputs.PRIVATE_KEY }}
        run: |
          mcp-publisher login dns -domain ansvar.eu -private-key "$PRIVATE_KEY"

      - name: Publish to MCP Registry
        run: mcp-publisher publish

      - name: Attach SBOM to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: sbom.cdx.json
          append_body: true
          body: |
            ### Supply Chain Artifacts
            - `sbom.cdx.json` -- CycloneDX SBOM for this release

      - name: Deployment Summary
        env:
          PKG_VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          echo "## Publication Complete" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** $PKG_VERSION" >> $GITHUB_STEP_SUMMARY
